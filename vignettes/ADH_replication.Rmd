---
title: "Inference in Bartik Designs"
author: "Michal KolesÃ¡r"
date: "`r Sys.Date()`"

bibliography: bartik_library.bib
output:
  pdf_document:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Inference in Bartik Designs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE, cache=FALSE}
library("knitr")
knitr::opts_knit$set(self.contained = FALSE)
knitr::opts_chunk$set(tidy = TRUE, collapse=TRUE, comment = "#>",
                      tidy.opts=list(blank=FALSE, width.cutoff=55))
```

The package `BartikSE` implements confidence intervals proposed by @akm18 for
@bartik91 style regressions. In the future, this file will illustrate the use of
this package. For now, we will just try to replicate Rodrigo's results for our
[@adh13, ADH hereafter] application.

The package contains the following data: a data frame `ADH` that contains the
outcome and control variables, `ADH_Xs` that is a vector of sectoral shocks that
we reconstructed, and `ADH_W`, the matrix of sectoral weights.

The correlation with the IV in ADH is quite high:
```{r}
library("BartikSE")
## Aggregate sectoral shocks
ADH$X <- ADH_W %*% ADH_Xs

cor(ADH$X, ADH$IV)
```

Strangely, there is almost a deterministic relationship between `IV` and `X`:

```{r fig.width=4.5, fig.height=3.5, fig.cap="ADH IV variable reconstruction"}
## See Figure 1 below for output
ggplot2::qplot(ADH$X, ADH$IV)+ggplot2::geom_abline(slope=1, intercept=0)+ggplot2::theme_bw()+
    ggplot2::labs(x="Our reconstruction", y="IV variable in ADH")
```



# Regressions

We now run the first-stage and reduced-form regressions and compute various
standard errors (I haven't coded up AKM0 yet):

```{r}
## definte vector of controls
ctrls <- "t2 + l_shind_manuf_cbp + l_sh_popedu_c + l_sh_popfborn +
          l_sh_empl_f + l_sh_routine33 + l_task_outsource + division"
## First stage
b1 <- lmBartik(as.formula(paste("shock ~ ", ctrls)), W=ADH_W, Xs=ADH_Xs,
                data=ADH, weights=weights, region_cvar=statefip,
                method="all")
b2 <- lmBartik(as.formula(paste("shock ~ ", ctrls)), W=ADH_W, Xs=ADH_Xs,
                data=ADH, method="all",
                region_cvar=statefip)
## Reduced form
 b3 <- lmBartik(as.formula(paste("d_sh_empl_mfg ~ ", ctrls)), W=ADH_W,
                Xs=ADH_Xs, data=ADH, region_cvar=statefip,
                weights=weights,
                method="all")
 b4 <- lmBartik(as.formula(paste("d_sh_empl_mfg ~ ", ctrls)), W=ADH_W,
                Xs=ADH_Xs, data=ADH, region_cvar=statefip,
                method="all")

```

First stage and reduced form for weighted regressions:
```{r}
b3
b1
```

This replicates exactly Rodrigo's results.


First stage and reduced form for unweighted regressions:
```{r}
b4
b2
```

Notice that the first-stage error is way smaller for AKM. This must be a
consequence of the fact that we're essentially running a sectoral regression.

# References
